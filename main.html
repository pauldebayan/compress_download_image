<!DOCTYPE html>
<html>
<head>
  <title>Compress and Download Image</title>
</head>
<body>

  <input type="text" id="filename" placeholder="Enter filename"/>
  <button id="compressButton">Compress and Download</button>
  
  <script>

    function blobToDataURL(blob, callback) {
        var a = new FileReader();
        a.onload = function(e) {callback(e.target.result);}
        a.readAsDataURL(blob);
    }

    async function pasteImage() {
        try {
            const clipboardContents = await navigator.clipboard.read();

            for (const item of clipboardContents) {
                
                const blob = await item.getType("image/png");

                await blobToDataURL(blob, await function(dataurl){

                    // After getting the data in datablob format compress and download it

                    compressImage(dataurl, 80) // 80% quality
                    .then(compressedDataURL => {


                        const link = document.createElement('a');
                        link.href = compressedDataURL;
                        link.download = document.getElementById('filename').value.trim() || 'compressed.jpg'; // Default filename

                        // Simulate a click to trigger the download
                        document.body.appendChild(link); // Append link to the body
                        link.click(); // Trigger the download
                        document.body.removeChild(link); 

                    })
                    .catch(error => {
                        console.error('Error compressing image:', error);
                    });
                });
            }
        } catch (error) {
        
        }
    }

    // compressImage was generated by gemini.google.com
    function compressImage(imageData, quality) {
      return new Promise((resolve, reject) => {
        const image = new Image();
        image.src = imageData;

        image.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          // Calculate new dimensions based on quality and maximum width/height
          const maxWidth = 800; // Adjust as needed
          const maxHeight = 400; // Adjust as needed
          const ratio = Math.min(maxWidth / image.width, maxHeight / image.height);
          const newWidth = Math.floor(image.width * ratio);
          const newHeight = Math.floor(image.height * ratio);

          // Resize canvas
          canvas.width = newWidth;
          canvas.height = newHeight;

          // Draw image onto canvas
          ctx.drawImage(image, 0, 0, newWidth, newHeight);

          // Convert canvas to data URL with specified quality
          const dataURL = canvas.toDataURL('image/jpeg', quality / 100);

          // Resolve promise with compressed data URL
          resolve(dataURL);
        };

        image.onerror = () => {
          reject(new Error('Error loading image'));
        };
      });
    }

    const compressButton = document.getElementById('compressButton');
    compressButton.addEventListener('click', async () => await pasteImage());

  </script>
</body>
</html>
